YUI.add("moodle-quizaccess_offlinemode-download",function(e,t){M.quizaccess_offlinemode=M.quizaccess_offlinemode||{},M.quizaccess_offlinemode.download={SELECTORS:{QUIZ_FORM:"#responseform",LINK_CONTAINER:"#mod_quiz_navblock .othernav"},filename:null,publicKey:null,form:null,link:null,init:function(t,n){this.filename=t,this.publicKey=n,this.form=e.one(this.SELECTORS.QUIZ_FORM);if(!this.form)return;var r=e.one(this.SELECTORS.LINK_CONTAINER);if(!r)return;this.link=r.appendChild('<a download="'+t+'" href="#">Emergency response export</a>'),this.link.on("click",this.downloadClicked,this)},downloadClicked:function(){typeof tinyMCE!="undefined"&&tinyMCE.triggerSave(),this.link.set("download",this.link.get("download").replace(/-d\d+\.attemptdata/,"-d"+this.getCurrentDatestamp()+".attemptdata"));var t={responses:e.IO.stringify(this.form)};if(this.publicKey){t.rawresponses=t.responses;var n=new e.Crypto.JSEncrypt;n.setPublicKey(this.publicKey);var r=new e.Crypto.SecureRandom,i=[];i.length=96,r.nextBytes(i);var s="";for(var o=0;o<96;o++)s+=String.fromCharCode(i[o]);t.responses=btoa(e.Crypto.rc4(s,t.responses)),t.envelope=n.encrypt(s),t.plainkey=btoa(s)}this.link.set("href","data:application/octet-stream,"+e.JSON.stringify(t))},getCurrentDatestamp:function(){function t(e){return e<10?"0"+e:e}var e=new Date;return""+e.getUTCFullYear()+t(e.getUTCMonth()+1)+t(e.getUTCDate())+t(e.getUTCHours())+t(e.getUTCMinutes())}}},"@VERSION@",{requires:["base","node","event","node-event-delegate","io-form","moodle-quizaccess_offlinemode-jsencrypt"]});
