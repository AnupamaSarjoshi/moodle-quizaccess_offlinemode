YUI.add("moodle-quizaccess_offlinemode-navigation",function(n,t){M.quizaccess_offlinemode=M.quizaccess_offlinemode||{},M.quizaccess_offlinemode.navigation={SELECTORS:{QUIZ_FORM:"#responseform",NAV_BLOCK:"#mod_quiz_navblock",NAV_BUTTON:".qnbutton",FINISH_LINK:".endtestlink",NEXT_BUTTON:"input[name=next]",SUMMARY_TABLE:".quizsummaryofattempt",SUMMARY_TABLE_LINK:"tr > td.c0 > a",SUMMARY_ROW:".quizsummaryofattempt tr.quizsummary",SUMMARY_LINK_IN_ROW:" > td.c0 > a",FLAG_ICON_IN_ROW:" .questionflag",SUMMARY_PAGE_BUTTON:"#quizaccess_offlinemode-attempt_page--1 .submitbtns [type=submit]",PAGE_DIV_ROOT:"#quizaccess_offlinemode-attempt_page-",ALL_PAGE_DIVS:"div[id|=quizaccess_offlinemode-attempt_page]",THIS_PAGE_INPUT:"input#followingpage",NEXT_PAGE_INPUT:"input[name=nextpage]",FINISH_ATTEMPT_INPUT:"input[name=finishattempt]"},form:null,currentpage:null,lastpage:null,extraspaceattop:0,init:function(t){if(this.form=n.one(this.SELECTORS.QUIZ_FORM),this.form){n.on("load",this.preload_images,window,this),n.all("textarea").each(function(t){t.setStyle("height",t.getStyle("height"))}),n.all(this.SELECTORS.ALL_PAGE_DIVS).each(function(t){var e,i=t.get("id").match(/quizaccess_offlinemode-attempt_page-(\d+)/);i&&(e=+i[1])>this.lastpage&&(this.lastpage=e)},this),n.all(this.SELECTORS.ALL_PAGE_DIVS).addClass("hidden"),this.navigate_to_page(+t),n.all(this.SELECTORS.ALL_PAGE_DIVS).removeClass("quiz-loading-hide"),n.delegate("click",this.nav_button_click,this.SELECTORS.NAV_BLOCK,this.SELECTORS.NAV_BUTTON,this),n.delegate("click",this.nav_button_click,this.SELECTORS.SUMMARY_TABLE,this.SELECTORS.SUMMARY_TABLE_LINK,this),n.one(this.SELECTORS.FINISH_LINK).detach("click"),n.one(this.SELECTORS.FINISH_LINK).on("click",this.finish_attempt_click,this),n.one(this.SELECTORS.NEXT_BUTTON).on("click",this.next_button_click,this),n.one(this.SELECTORS.SUMMARY_PAGE_BUTTON).on("click",this.summary_button_click,this);var e=n.one(".navbar-fixed-top");e&&(this.extraspaceattop=e.get("offsetHeight")),M.core_question_flags&&M.core_question_flags.add_listener(n.bind(this.update_flag_on_summary_page,this))}},preload_images:function(){var i={};function a(t){i[t]=!0,document.createElement("img").src=t}a(M.util.image_url("i/flagged")),a(M.util.image_url("i/unflagged")),a(M.util.image_url("i/loading_small")),n.all("img").each(function(t){var e=t.get("src");i[e]||a(e)})},nav_button_click:function(t){t.halt(),t.currentTarget.hasAttribute("href")&&(this.navigate_to_page(this.page_number_from_link(t.currentTarget)),this.scroll_to_fragment_from_link(t.currentTarget))},finish_attempt_click:function(t){t.halt(!0),this.navigate_to_page(-1)},next_button_click:function(t){t.halt(),this.navigate_to_page(+n.one(this.SELECTORS.NEXT_PAGE_INPUT).get("value"))},summary_button_click:function(t){t.currentTarget.siblings(this.SELECTORS.FINISH_ATTEMPT_INPUT).empty()&&(t.halt(),this.navigate_to_page(+n.one(this.SELECTORS.THIS_PAGE_INPUT).get("value")))},page_number_from_link:function(t){var e,i=t.getData("quiz-page");return i!==undefined?+i:t.hasAttribute("href")&&(e=t.get("href").match(/page=(\d+)/))?+e[1]:0},scroll_to_fragment_from_link:function(t){var e,i,a=t.get("href").match(/#(?:q\d+)?$/);a&&(window.history.replaceState&&((e=window.location.href).match(/#[^#]*$/)?e=e.replace(/#[^#]*$/,a[0]):e+=a[0],window.history.replaceState(null,"",e)),"#"===a[0]&&window.scrollTo(0,0),(i=n.one(a[0]))&&window.scrollTo(0,i.getY()-this.extraspaceattop))},navigate_to_page:function(e){if(e!==this.currentpage){if(null!==this.currentpage&&n.one(this.SELECTORS.PAGE_DIV_ROOT+this.currentpage).addClass("hidden"),-1===e?n.one(this.SELECTORS.QUIZ_FORM).addClass("hidden"):n.one(this.SELECTORS.QUIZ_FORM).removeClass("hidden"),n.one(this.SELECTORS.PAGE_DIV_ROOT+e).removeClass("hidden"),n.one(this.SELECTORS.NAV_BLOCK).all(this.SELECTORS.NAV_BUTTON).each(function(t){this.page_number_from_link(t)===e?t.addClass("thispage"):t.removeClass("thispage")},this),0<=e&&(n.one(this.SELECTORS.THIS_PAGE_INPUT).set("value",e),e<this.lastpage?n.one(this.SELECTORS.NEXT_PAGE_INPUT).set("value",e+1):n.one(this.SELECTORS.NEXT_PAGE_INPUT).set("value",-1)),window.history.replaceState){var t=window.location.search;t.match(/\bpage=-?\d+/)?t=t.replace(/\bpage=-?\d+/,"page="+e):t+="&page="+e,window.history.replaceState(null,"",M.cfg.wwwroot+"/mod/quiz/accessrule/offlinemode/attempt.php"+t)}this.currentpage=e,window.scrollTo(0,0)}},update_flag_on_summary_page:function(t,e,i){if("1"===i){var a=n.Node.create('<img class="questionflag icon-post" />').setAttrs({src:M.util.image_url("i/flagged","core"),title:M.util.get_string("flagged","question")});n.one(this.SELECTORS.SUMMARY_ROW+e+this.SELECTORS.SUMMARY_LINK_IN_ROW).append(a)}else n.all(this.SELECTORS.SUMMARY_ROW+e+this.SELECTORS.FLAG_ICON_IN_ROW).remove()}}},"@VERSION@",{requires:["base","node","event","event-valuechange","node-event-delegate","io-form","moodle-core-notification-confirm"]});